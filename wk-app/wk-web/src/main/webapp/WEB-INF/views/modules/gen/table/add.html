<%
layout("/layouts/platform.html"){
%>
<header class="header navbar bg-white shadow">
    <!-- 左按钮区 -->
    <div class="btn-group tool-button">
        <a id="add" class="btn btn-primary navbar-btn" href="${base}/gen/table" data-pjax><i class="ti-angle-left"></i> 返回</a>
    </div>
    <!--<div class="pull-right">-->
    <!--<div class="btn-group tool-button">-->
    <!--<button class="btn btn-primary navbar-btn" onclick="complete()"><i class="ti-share"></i> 立即完成</button>-->
    <!--</div>-->
    <!--</div>-->
</header>
<div class="content-wrap">
    <div class="wrapper">
        <div class="row mb15">
            <div class="col-lg-12">
                <form id="addRoleForm" class="form-horizontal stepy" method="post" action="${base}/platform/sys/role/addDo">
                    <fieldset title="第 1 步&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;">
                        <legend>选择业务表</legend>
                        <div class="form-group">
                            <div class="form-group">
                                <label for="databaseTableName" class="col-sm-1 control-label">表名</label>
                                <!--<div class="col-sm-8">
                                    <div class="input-group">
                                        <input id="databaseTableName" type="text" class="form-control" placeholder="请选择需要添加的业务表" disabled
                                               value="<%if(!isEmpty(obj)){%>${obj.name}<%}%>"/>

                                        <span class="input-group-btn">
			                             			<button type="button" class="btn btn-primary" data-toggle="modal"
                                                            data-target="#dialogSelectTable"><i class="ti-plus"></i>选择
                                                    </button>
			                             		</span>
                                    </div>
                                    <input type="hidden" name="databaseTableName" value="<%if(!isEmpty(obj)){%>${obj.id}<%}%>">
                                </div>-->
                                <div class="col-sm-8">
                                    <select id="databaseTableName" name="databaseTableName" data-parsley-required="true" class="form-control">
                                        <option value="">请选择需要添加的业务表</option>
                                        <%if(!isEmpty(tableList)){
                                            for(table in tableList){
                                            %>
                                                <option value="${table.tableName},${table.comments}">${table.tableName}: ${table.comments}</option>
                                            <%
                                            }
                                        }%>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset title="第 2 步&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;">
                        <legend>基本信息</legend>

                        <div class="form-group">
                            <label for="tableName" class="col-sm-1 control-label">表名</label>

                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="tableName" name="tableName" validate="true" placeholder="表名"
                                       maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="comments" class="col-sm-1 control-label">表说明</label>

                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="comments" name="comments" placeholder="表说明"
                                       maxlength="50">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="className" class="col-sm-1 control-label">实体类名</label>

                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="className" name="className" validate="true" placeholder="实体类名"
                                       maxlength="50">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="functionAuthor" class="col-sm-1 control-label">功能作者</label>

                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="functionAuthor" name="functionAuthor" validate="true" placeholder="功能作者"
                                       maxlength="50">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="parentTableName" class="col-sm-1 control-label">关联父表</label>

                            <div class="col-sm-11">
                                <select id="parentTableName" name="parentTableName" data-parsley-required="true" class="form-control">
                                    <option value="">请选择关联父表</option>
                                    <%if(!isEmpty(tableList)){
                                        for(table in tableList){
                                        %>
                                            <option value="${table.tableName},${table.comments}">${table.tableName}: ${table.comments}</option>
                                        <%
                                        }
                                    }%>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="parentTableFkName" class="col-sm-1 control-label">关联父表外键</label>

                            <div class="col-sm-11">
                                <select id="parentTableFkName" name="parentTableFkName" data-parsley-required="true" class="form-control">
                                    <option value="">请选择关联父表外键</option>
                                    <%if(!isEmpty(tableColumnList)){
                                        for(tableColumn in tableColumnList){
                                        %>
                                            <option value="${tableColumn.tableColumnName},${tableColumn.tableColumnComments}">${tableColumn.tableColumnName}: ${tableColumn.tableColumnComments}</option>
                                        <%
                                        }
                                    }%>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="remarks" class="col-sm-1 control-label">备注</label>

                            <div class="col-sm-11">
                                <textarea class="form-control" id="remarks" name="remarks" placeholder="备注" maxlength="50"></textarea>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset title="第 3 步&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;">
                        <legend>字段列表</legend>

                        <table class="table table-bordered table-striped mg-t datatable">
                            <thead>
                            <tr>
                                <!--字段-->
                                <th>排序</th>
                                <th>列名</th>
                                <th>列说明</th>
                                <th>字段类型</th>
                                <th>属性类型</th>
                                <th>属性名称</th>
                                <th>主键</th>
                                <th>插入</th>
                                <th>更新</th>

                                <!--列表-->
                                <th>列表</th>
                                <th>查询</th>
                                <th>匹配方式</th>

                                <!--表单-->
                                <th>编辑</th>
                                <th>必填</th>
                                <th>控件类型</th>
                                <th>栅格</th>
                                <th>新行</th>
                                <th>字典类型</th>
                                <th>字段验证</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </fieldset>
                    <button class="stepy-finish btn btn-primary pull-right" data-loading-text="正在提交...">完成</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script language="JavaScript">
    function initTableColumn(tableName) {
        /*datatable = $('.datatable').DataTable({
            "dom": '<"toolbar">frtip',
            "searching": false,
            "processing": false,
            "serverSide": true, //启用服务器端处理模式
            "select": true,
            "ordering": true,
            "language": {
                "url": "${base}/assets/plugins/datatables/cn.json"
            },
            "preDrawCallback": function () {
                sublime.showLoadingbar($(".main-content"));
            },
            "drawCallback": function () {
                sublime.closeLoadingbar($(".main-content"));
            },
            "ajax": {
                "url": "${base}/gen/tableColumn/getDatabaseTableColumnList?tableName="+tableName,
                "type": "post",
                "data": function (d) {
                }
            },
            "order": [[20, "desc"]],
            "columns": [
                {"data": "columnSort", "bSortable": false},
                {"data": "columnName", "bSortable": true, width: 80},
                {"data": "comments", "bSortable": false},
                {"data": "columnType", "bSortable": false},
                {"data": "attrType", "bSortable": false},
                {"data": "attrName", "bSortable": false},
                {"data": "isPk", "bSortable": false},
                {"data": "isInsert", "bSortable": false},
                {"data": "isUpdate", "bSortable": false},
                {"data": "isList", "bSortable": false},
                {"data": "isQuery", "bSortable": false},
                {"data": "queryType", "bSortable": false},
                {"data": "isEdit", "bSortable": false},
                {"data": "isNull", "bSortable": false},
                {"data": "showType", "bSortable": false},
                {"data": "gridType", "bSortable": false},
                {"data": "isNewLine", "bSortable": false},
                {"data": "dictType", "bSortable": false},
                {"data": "fieldValidation", "bSortable": false}
            ],
            "columnDefs": [
                {
                    "render": function (data, type, row) {
                        return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            '<i class="ti-settings"></i> <span class=""ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li><a href="${base}/gen/table/add'+ row.id +'" data-pjax>修改</a></li>' +
                            '<li class="divider"></li>' +
                            '<li><a href="javascript:void(0);" onclick=del(\''+ row.id + '\')">删除</a></li>' +
                            '</ul></div>';
                    },
                    "targets": 20
                }
            ]
        });*/
        datatable = $('.datatable').DataTable({
            "dom": '<"toolbar">frtip',
            "searching": false,
            "processing": false,
            "serverSide": true,
            "select": true,
            "ordering": true,
            "language": {
                "url": "${base}/assets/plugins/datatables/cn.json"
            },
            "preDrawCallback": function () {
                sublime.showLoadingbar($(".main-content"));
            },
            "drawCallback": function () {
                sublime.closeLoadingbar($(".main-content"));
            },
            "ajax": {
                "url": "${base}/gen/tableColumn/getDatabaseTableColumnList?tableName="+tableName,
                "type": "post",
                "data": function (d) {
                    d.unitid = $('#unitid').val();
                }
            },
            "order": [[4, "desc"]],
            "columns": [
                {"data": "name", "bSortable": true, width: 80},
                {"data": "comments", "bSortable": false},
                {"data": "className", "bSortable": false},
                {"data": "parentTable", "bSortable": true}
            ],
            "columnDefs": [
                {
                    "render": function (data, type, row) {
                        return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            '   <i class="ti-settings"></i> <span class=""ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li><a href="${base}/gen/table/add'+ row.id +'" data-pjax>修改</a></li>' +
                            '<li class="divider"></li>' +
                            '<li><a href="javascript:void(0);" onclick=del(\''+ row.id + '\')">删除</a></li>' +
                            '</ul></div>';
                    },
                    "targets": 4
                }
            ]
        });
        datatable.on('click', 'tr', function () {
            $(this).toggleClass('selected');
        });
        $("#searchBtn").on('click', function () {
            datatable.ajax.reload();
        });
    }
    //选择父菜单
    function selectTable() {
        var tree = $.jstree.reference("#jsTreeUnit");
        var node = tree.get_selected(true);
        $("#unitName").val(node[0].text);
        $("#unitid").val(node[0].id);
        $("#dialogSelectUnit").modal("hide");
    }
    $(function () {
        var jsTreeMenu;
        $(".stepy").stepy({
            backLabel: "上一步",
            nextLabel: "下一步",
            errorImage: true,
            block: true,
            validate: true,
            legend: false,
            select: function (idx) {
                var databaseTableInfoArray = $("#databaseTableName").val().split(",");
                var tableName = databaseTableInfoArray[0];
                var tableComments = databaseTableInfoArray[1];

                if (idx == 2) {

                    var className = "";
                    var tableNameArray = tableName.split("_");
                    for(i in tableNameArray){
                        var word = tableNameArray[i];
                        className += word.charAt(0).toUpperCase() + word.slice(1);
                    }

                    $("#tableName").val(tableName);
                    $("#comments").val(tableComments);
                    $("#className").val(className);
                }
                if(idx == 3){
                    initTableColumn(tableName);
                }
            }, finish: function(index) {
                var tree = $.jstree.reference("#jsTreeMenu");
                var nodes = tree.get_selected();
                //查询所选节点的所有父节点
                for (var i = 0; i < nodes.length; i++) {
                    var node = nodes[i];
                    each(node, tree, nodes);
                }
                $("#menuIds").val(nodes);

            }
        });
        $(".stepy").validate({
            errorPlacement: function (error) {
                $(".stepy .stepy-errors").append(error)
            },
            rules: {
                unitName: "required",
                name: "required",
                code: "required"
            },
            messages: {
                unitName: {
                    required: "必须选择单位"
                },
                name: {
                    required: "角色名不能为空"
                },
                code: {
                    required: "权限标识不能为空"
                }
            }
        });
        //表单ajax提交
        $("#addRoleForm").ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {
                //获取选择的菜单
                form.find("button:submit").button("loading");
                if (form.attr("isSubmit") == undefined) {//与stepy结合使用时，要避免二次提交的问题
                    form.attr("isSubmit", true);
                } else {
                    form.removeAttr("isSubmit");
                    return false;
                }
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    Toast.success("角色增加成功！");
                    form.resetForm();
                    $("#menuIds").val("");
                    //回到第一个step
                    $(".stepy").stepy("step", 1);
                } else {
                    Toast.error(data.msg);
                }
                form.find("button:submit").button("reset");
            }
        });
        myForm.init();
    });
    function complete() {
        $('#addRoleForm').submit();
    }
    function each(node, tree, nodes) {
        var p = tree.get_parent(node);
        if (p.length > 1) {
            if (nodes&&p&&nodes.indexOf(p)<0)
                nodes.push(p);
            each(p, tree, nodes);
        }
    }
</script>


<%}%>